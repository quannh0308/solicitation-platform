# Infrastructure Audit Report
## Complete Event Analytics Platform (CEAP)

**Date:** 2025-01-27  
**Purpose:** Audit current 7-stack infrastructure before consolidation to 3 stacks  
**Environment:** dev (default)

---

## Executive Summary

The CEAP platform currently consists of **7 CloudFormation stacks** (excluding ObservabilityStack):

1. **CeapDatabase-dev** - Storage layer (3 DynamoDB tables)
2. **CeapEtlWorkflow-dev** - ETL Lambda function
3. **CeapFilterWorkflow-dev** - Filter Lambda function
4. **CeapScoreWorkflow-dev** - Score Lambda function
5. **CeapStoreWorkflow-dev** - Store Lambda function
6. **CeapReactiveWorkflow-dev** - Reactive Lambda + EventBridge rule + Deduplication table
7. **CeapOrchestration-dev** - Step Functions workflow + EventBridge schedule

**Total Resources:** 
- 4 DynamoDB Tables
- 5 Lambda Functions
- 1 Step Functions State Machine
- 2 EventBridge Rules
- 5+ IAM Roles (auto-generated by CeapLambda construct)
- CloudWatch Log Groups (auto-generated)

---

## Stack 1: CeapDatabase-dev (Storage Layer)

**Purpose:** Centralized database infrastructure for all workflows

### Resources

#### 1.1 DynamoDB Tables

**CandidatesTable** (`Candidates-dev`)
- **Type:** DynamoDB Table
- **Partition Key:** PK (String)
- **Sort Key:** SK (String)
- **Billing Mode:** PAY_PER_REQUEST
- **TTL Attribute:** ttl
- **Point-in-Time Recovery:** Enabled
- **Encryption:** AWS_MANAGED
- **Removal Policy:** RETAIN (prod), DESTROY (dev)
- **Global Secondary Indexes:**
  - **ProgramChannelIndex:** GSI1PK (String), GSI1SK (String), ProjectionType: ALL
  - **ProgramDateIndex:** GSI2PK (String), GSI2SK (String), ProjectionType: ALL
- **Exports:** Table name, Table ARN (implicit via CDK references)
- **Importing Stacks:** EtlWorkflow, StoreWorkflow, ReactiveWorkflow

**ProgramConfigTable** (`ProgramConfig-dev`)
- **Type:** DynamoDB Table
- **Partition Key:** PK (String)
- **Sort Key:** SK (String)
- **Billing Mode:** PAY_PER_REQUEST
- **Point-in-Time Recovery:** Enabled
- **Encryption:** AWS_MANAGED
- **Removal Policy:** RETAIN (prod), DESTROY (dev)
- **Exports:** Table name, Table ARN (implicit via CDK references)
- **Importing Stacks:** EtlWorkflow, FilterWorkflow, ReactiveWorkflow

**ScoreCacheTable** (`ScoreCache-dev`)
- **Type:** DynamoDB Table
- **Partition Key:** PK (String)
- **Sort Key:** SK (String)
- **Billing Mode:** PAY_PER_REQUEST
- **TTL Attribute:** ttl
- **Point-in-Time Recovery:** Enabled
- **Encryption:** AWS_MANAGED
- **Removal Policy:** DESTROY (all environments - cache data)
- **Exports:** Table name, Table ARN (implicit via CDK references)
- **Importing Stacks:** ScoreWorkflow, ReactiveWorkflow

### Cross-Stack Dependencies
- **Depended on by:** All workflow stacks (ETL, Filter, Score, Store, Reactive)
- **Depends on:** None (base layer)

### Notes
- This stack remains **unchanged** in the consolidation (Requirement 1.2)
- All table references use direct CDK object references (not CloudFormation exports)
- IAM permissions granted via CeapLambda construct

---

## Stack 2: CeapEtlWorkflow-dev (Write Path - ETL)

**Purpose:** Extract and transform candidate data from sources

### Resources

#### 2.1 Lambda Functions

**ETLLambda**
- **Type:** AWS::Lambda::Function
- **Handler:** com.ceap.workflow.etl.ETLHandler::handleRequest
- **Runtime:** Java (inferred from .jar)
- **Memory:** 1024 MB
- **Timeout:** 5 minutes
- **JAR Path:** ../ceap-workflow-etl/build/libs/ceap-workflow-etl-1.0.0-SNAPSHOT.jar
- **Environment Variables:**
  - ENVIRONMENT: dev
  - CANDIDATES_TABLE: Candidates-dev
  - PROGRAM_CONFIG_TABLE: ProgramConfig-dev
  - BATCH_SIZE: 1000
  - LOG_LEVEL: INFO
- **IAM Permissions:** 
  - DynamoDB read/write on CandidatesTable
  - DynamoDB read on ProgramConfigTable
  - CloudWatch Logs (auto-generated)
- **Used By:** OrchestrationStack (Step Functions workflow)

### Cross-Stack Dependencies
- **Depends on:** DatabaseStack (CandidatesTable, ProgramConfigTable)
- **Referenced by:** OrchestrationStack (Lambda invocation in Step Functions)

### Notes
- Part of the **Write Path** - will move to CeapDataPlatform-dev
- TODO: Add Athena and S3 permissions for data connectors (commented in code)

---

## Stack 3: CeapFilterWorkflow-dev (Write Path - Filter)

**Purpose:** Apply filtering rules to candidates

### Resources

#### 3.1 Lambda Functions

**FilterLambda**
- **Type:** AWS::Lambda::Function
- **Handler:** com.ceap.workflow.filter.FilterHandler::handleRequest
- **Runtime:** Java (inferred from .jar)
- **Memory:** 512 MB
- **Timeout:** 60 seconds
- **JAR Path:** ../ceap-workflow-filter/build/libs/ceap-workflow-filter-1.0.0-SNAPSHOT.jar
- **Environment Variables:**
  - ENVIRONMENT: dev
  - PROGRAM_CONFIG_TABLE: ProgramConfig-dev
  - LOG_LEVEL: INFO
- **IAM Permissions:**
  - DynamoDB read on ProgramConfigTable
  - CloudWatch Logs (auto-generated)
- **Used By:** OrchestrationStack (Step Functions workflow)

### Cross-Stack Dependencies
- **Depends on:** DatabaseStack (ProgramConfigTable)
- **Referenced by:** OrchestrationStack (Lambda invocation in Step Functions)

### Notes
- Part of the **Write Path** - will move to CeapDataPlatform-dev

---

## Stack 4: CeapScoreWorkflow-dev (Write Path - Score)

**Purpose:** Execute scoring models on candidates

### Resources

#### 4.1 Lambda Functions

**ScoreLambda**
- **Type:** AWS::Lambda::Function
- **Handler:** com.ceap.workflow.score.ScoreHandler::handleRequest
- **Runtime:** Java (inferred from .jar)
- **Memory:** 1024 MB
- **Timeout:** 2 minutes
- **JAR Path:** ../ceap-workflow-score/build/libs/ceap-workflow-score-1.0.0-SNAPSHOT.jar
- **Environment Variables:**
  - ENVIRONMENT: dev
  - SCORE_CACHE_TABLE: ScoreCache-dev
  - CACHE_TTL_HOURS: 24
  - LOG_LEVEL: INFO
- **IAM Permissions:**
  - DynamoDB read/write on ScoreCacheTable
  - CloudWatch Logs (auto-generated)
- **Used By:** OrchestrationStack (Step Functions workflow)

### Cross-Stack Dependencies
- **Depends on:** DatabaseStack (ScoreCacheTable)
- **Referenced by:** OrchestrationStack (Lambda invocation in Step Functions)

### Notes
- Part of the **Write Path** - will move to CeapDataPlatform-dev
- TODO: Add SageMaker endpoint permissions (commented in code)

---

## Stack 5: CeapStoreWorkflow-dev (Write Path - Store)

**Purpose:** Batch write candidates to DynamoDB

### Resources

#### 5.1 Lambda Functions

**StoreLambda**
- **Type:** AWS::Lambda::Function
- **Handler:** com.ceap.workflow.store.StoreHandler::handleRequest
- **Runtime:** Java (inferred from .jar)
- **Memory:** 512 MB
- **Timeout:** 60 seconds
- **JAR Path:** ../ceap-workflow-store/build/libs/ceap-workflow-store-1.0.0-SNAPSHOT.jar
- **Environment Variables:**
  - ENVIRONMENT: dev
  - CANDIDATES_TABLE: Candidates-dev
  - BATCH_SIZE: 25
  - LOG_LEVEL: INFO
- **IAM Permissions:**
  - DynamoDB write on CandidatesTable
  - CloudWatch Logs (auto-generated)
- **Used By:** OrchestrationStack (Step Functions workflow)

### Cross-Stack Dependencies
- **Depends on:** DatabaseStack (CandidatesTable)
- **Referenced by:** OrchestrationStack (Lambda invocation in Step Functions)

### Notes
- Part of the **Write Path** - will move to CeapDataPlatform-dev

---

## Stack 6: CeapReactiveWorkflow-dev (Read Path - Reactive)

**Purpose:** Handle real-time customer events

### Resources

#### 6.1 DynamoDB Tables

**DeduplicationTable** (`ceap-event-deduplication-dev`)
- **Type:** DynamoDB Table
- **Partition Key:** deduplicationKey (String)
- **Billing Mode:** PAY_PER_REQUEST
- **TTL Attribute:** ttl
- **Exports:** Table name, Table ARN (implicit via CDK references)
- **Importing Stacks:** None (used only by ReactiveWorkflow)

#### 6.2 Lambda Functions

**ReactiveLambda**
- **Type:** AWS::Lambda::Function
- **Handler:** com.ceap.workflow.reactive.ReactiveHandler::handleRequest
- **Runtime:** Java (inferred from .jar)
- **Memory:** 1024 MB
- **Timeout:** 1 minute
- **JAR Path:** ../ceap-workflow-reactive/build/libs/ceap-workflow-reactive-1.0.0-SNAPSHOT.jar
- **Environment Variables:**
  - ENVIRONMENT: dev
  - CANDIDATES_TABLE: Candidates-dev
  - PROGRAM_CONFIG_TABLE: ProgramConfig-dev
  - SCORE_CACHE_TABLE: ScoreCache-dev
  - DEDUPLICATION_TABLE: ceap-event-deduplication-dev
  - LOG_LEVEL: INFO
- **IAM Permissions:**
  - DynamoDB read/write on CandidatesTable, ProgramConfigTable, ScoreCacheTable, DeduplicationTable
  - CloudWatch Logs (auto-generated)
  - EventBridge invocation (auto-granted)

#### 6.3 EventBridge Rules

**CustomerEventRule** (`ceap-customer-events-dev`)
- **Type:** AWS::Events::Rule
- **Description:** Routes customer events to reactive ceap workflow
- **Event Pattern:**
  - Source: ceap.customer-events
  - DetailType: OrderDelivered, ProductPurchased, VideoWatched, TrackPlayed, ServiceCompleted, EventAttended
- **Targets:** ReactiveLambda

### Cross-Stack Dependencies
- **Depends on:** DatabaseStack (CandidatesTable, ProgramConfigTable, ScoreCacheTable)
- **Referenced by:** OrchestrationStack (passed as parameter but not directly invoked)

### Notes
- Part of the **Read Path** - will move to CeapServingAPI-dev
- Validates Requirements 9.1, 9.2, 9.5 (per code comments)
- DeduplicationTable is specific to this workflow and will move with it

---

## Stack 7: CeapOrchestration-dev (Write Path - Orchestration)

**Purpose:** Orchestrate batch ingestion workflow and scheduling

### Resources

#### 7.1 Step Functions State Machines

**BatchIngestionWorkflow** (`CeapBatchIngestion-dev`)
- **Type:** AWS::StepFunctions::StateMachine
- **Timeout:** 4 hours
- **Definition:** Chain of Lambda invocations with error handling
  - **ETLTask:** Invokes ETLLambda
    - Retry: 5 attempts, exponential backoff (1s, 2s, 4s, 8s, 16s)
    - Catch: ETLFailed state
  - **FilterTask:** Invokes FilterLambda
    - Retry: 5 attempts, exponential backoff
    - Catch: FilterFailed state
  - **ScoreTask:** Invokes ScoreLambda
    - Retry: 5 attempts, exponential backoff
    - Catch: ScoreFailed state
  - **StoreTask:** Invokes StoreLambda
    - Retry: 5 attempts, exponential backoff
    - Catch: StoreFailed state
  - **WorkflowSuccess:** Success state
- **IAM Permissions:**
  - Lambda invocation on all workflow Lambdas
  - CloudWatch Logs (auto-generated)

#### 7.2 EventBridge Rules

**BatchIngestionSchedule** (`CeapBatchIngestion-dev`)
- **Type:** AWS::Events::Rule
- **Schedule:** Cron (daily at 2 AM UTC: 0 2 * * ? *)
- **Targets:** BatchIngestionWorkflow

### Cross-Stack Dependencies
- **Depends on:** EtlWorkflow, FilterWorkflow, ScoreWorkflow, StoreWorkflow, ReactiveWorkflow (Lambda functions)
- **Depends on:** DatabaseStack (indirectly via Lambda functions)

### Notes
- Part of the **Write Path** - will move to CeapDataPlatform-dev
- ReactiveStack is passed as parameter but not used in current implementation
- Complex retry and error handling logic

---

## Cross-Stack Reference Analysis

### Current Reference Mechanism
All cross-stack references use **direct CDK object references** (not CloudFormation exports):
- Lambda functions passed directly to Step Functions tasks
- DynamoDB tables passed directly to Lambda environment variables via CeapLambda construct

### Reference Patterns

#### Pattern 1: Database Table References
```kotlin
// In workflow stacks
environment = mapOf(
    "CANDIDATES_TABLE" to databaseStack.candidatesTable.tableName,
    "PROGRAM_CONFIG_TABLE" to databaseStack.programConfigTable.tableName
)
```

#### Pattern 2: Lambda Function References
```kotlin
// In OrchestrationStack
val etlTask = LambdaInvoke.Builder.create(this, "ETLTask")
    .lambdaFunction(etlStack.etlLambda.function)
    .build()
```

#### Pattern 3: IAM Permission Grants
```kotlin
// In CeapLambda construct (implicit)
tables.forEach { table ->
    table.grantReadWriteData(function)
}
```

### Migration Considerations
- Current references work because all stacks are defined in the same CDK app
- After consolidation, references will still work within consolidated stacks
- No CloudFormation exports currently exist - will need to add for cross-stack references between the 3 new stacks
- CeapServingAPI-dev may need to reference CeapDataPlatform-dev resources (future requirement)

---

## Resource Mapping: 7-Stack → 3-Stack Architecture

### Target Stack 1: CeapDatabase-dev (Storage Layer)
**Status:** UNCHANGED

**Resources:**
- ✓ CandidatesTable (from DatabaseStack)
- ✓ ProgramConfigTable (from DatabaseStack)
- ✓ ScoreCacheTable (from DatabaseStack)

### Target Stack 2: CeapDataPlatform-dev (Write Path)
**Consolidates:** EtlWorkflow, FilterWorkflow, ScoreWorkflow, StoreWorkflow, Orchestration

**Resources:**
- ✓ ETLLambda (from EtlWorkflowStack)
- ✓ FilterLambda (from FilterWorkflowStack)
- ✓ ScoreLambda (from ScoreWorkflowStack)
- ✓ StoreLambda (from StoreWorkflowStack)
- ✓ BatchIngestionWorkflow (from OrchestrationStack)
- ✓ BatchIngestionSchedule (from OrchestrationStack)
- ✓ ETLTask, FilterTask, ScoreTask, StoreTask (Step Functions tasks from OrchestrationStack)
- ✓ ETLFailed, FilterFailed, ScoreFailed, StoreFailed (Fail states from OrchestrationStack)
- ✓ WorkflowSuccess (Success state from OrchestrationStack)

**Total:** 5 Lambda Functions, 1 State Machine, 1 EventBridge Rule, 9 Step Functions states

### Target Stack 3: CeapServingAPI-dev (Read Path)
**Consolidates:** ReactiveWorkflow

**Resources:**
- ✓ ReactiveLambda (from ReactiveWorkflowStack)
- ✓ CustomerEventRule (from ReactiveWorkflowStack)
- ✓ DeduplicationTable (from ReactiveWorkflowStack)

**Total:** 1 Lambda Function, 1 EventBridge Rule, 1 DynamoDB Table

---

## CloudFormation Template Backup

### Current Templates Location
Templates are generated by CDK from Kotlin code. To export current templates:

```bash
# Synthesize CloudFormation templates
cd infrastructure
cdk synth --all --output=../backup-templates-$(date +%Y%m%d)
```

### Backup Checklist
- [ ] Export all 7 stack templates
- [ ] Save CDK context (cdk.context.json)
- [ ] Document current parameter values
- [ ] Save IAM role policies (auto-generated)
- [ ] Export current resource ARNs
- [ ] Document current environment variables

---

## Validation Checklist

### Resource Count Validation
- [x] 4 DynamoDB Tables identified (3 in Database, 1 in Reactive)
- [x] 5 Lambda Functions identified
- [x] 1 Step Functions State Machine identified
- [x] 2 EventBridge Rules identified
- [x] All cross-stack dependencies documented

### Dependency Validation
- [x] All workflow stacks depend on DatabaseStack
- [x] OrchestrationStack depends on all workflow stacks
- [x] No circular dependencies detected
- [x] Deployment order clear: Database → Workflows → Orchestration

### Configuration Validation
- [x] All environment variables documented
- [x] All IAM permissions documented
- [x] All timeout and memory configurations documented
- [x] All retry and error handling logic documented

---

## Risk Assessment

### Low Risk
- ✓ Database stack unchanged (Requirement 1.2)
- ✓ All resources use consistent naming patterns
- ✓ No CloudFormation exports to migrate (using CDK references)
- ✓ Clear separation between Write Path and Read Path

### Medium Risk
- ⚠ Large consolidated stacks may approach CloudFormation limits
- ⚠ Deployment time may increase with more resources per stack
- ⚠ Step Functions definition embedded in OrchestrationStack (complex to migrate)

### Mitigation Strategies
- Monitor CloudFormation template size during consolidation
- Test deployment time in test environment (Requirement 4.1, 4.2)
- Preserve Step Functions definition structure exactly
- Use CloudFormation exports for future cross-stack references

---

## Next Steps

1. **Create consolidated templates** (Task 2)
   - Create CeapDataPlatform-dev template structure
   - Migrate ETL, Filter, Score, Store, Orchestration resources
   - Create CeapServingAPI-dev template structure
   - Migrate Reactive resources

2. **Add CloudFormation exports** (for future cross-stack references)
   - Export database table ARNs from CeapDatabase-dev
   - Export orchestration workflow ARN from CeapDataPlatform-dev
   - Add parameters for cross-stack references

3. **Validate consolidated templates** (Task 3)
   - Run cfn-lint validation
   - Write property tests
   - Write unit tests

4. **Test deployment** (Task 6)
   - Deploy to test environment
   - Validate resource counts
   - Run integration tests
   - Measure deployment time

---

## Appendix A: Resource Inventory Summary

| Stack | Lambdas | Tables | State Machines | EventBridge Rules | Total Resources |
|-------|---------|--------|----------------|-------------------|-----------------|
| Database | 0 | 3 | 0 | 0 | 3 |
| EtlWorkflow | 1 | 0 | 0 | 0 | 1 |
| FilterWorkflow | 1 | 0 | 0 | 0 | 1 |
| ScoreWorkflow | 1 | 0 | 0 | 0 | 1 |
| StoreWorkflow | 1 | 0 | 0 | 0 | 1 |
| ReactiveWorkflow | 1 | 1 | 0 | 1 | 3 |
| Orchestration | 0 | 0 | 1 | 1 | 2 |
| **TOTAL** | **5** | **4** | **1** | **2** | **12** |

---

## Appendix B: Dependency Graph

```
CeapDatabase-dev (Storage Layer)
       ↓                    ↓                    ↓                    ↓                    ↓
CeapEtlWorkflow-dev  CeapFilterWorkflow-dev  CeapScoreWorkflow-dev  CeapStoreWorkflow-dev  CeapReactiveWorkflow-dev
       ↓                    ↓                    ↓                    ↓
       └────────────────────┴────────────────────┴────────────────────┘
                                    ↓
                          CeapOrchestration-dev
```

**After Consolidation:**

```
CeapDatabase-dev (Storage Layer)
       ↓                              ↓
CeapDataPlatform-dev          CeapServingAPI-dev
   (Write Path)                  (Read Path)
```

---

**End of Audit Report**
